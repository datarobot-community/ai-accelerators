---
version: '3'
includes:
  common:
    taskfile: ../core/task-common.yaml
    internal: true

tasks:
  auth-check:
    silent: true
    desc: "ğŸ” Check authentication prerequisites"
    cmds:
      - |
        if command -v dr &> /dev/null && dr auth help 2>&1 | grep -q "check"; then
          echo "ğŸ” Checking authentication.."
          dr auth check
        else
          echo "â„¹ï¸  Skipping auth check (not available)"
        fi

  install:
    desc: ğŸ”§ Install dependencies
    cmds:
      - echo "ğŸ”§ Installing dependencies.."
      - "{{.UV_CMD}} sync --all-extras --dev"
  uninstall:
    desc: "ğŸ”§ Uninstall dependencies"
    cmds:
      - echo "ğŸ”§ Uninstalling dependencies.."
      - rm -rf .venv

  start:
    silent: true
    desc: "ğŸ’» Installing prior to start"
    cmds:
      - task: migrate
  dev:
    silent: true
    desc: "ğŸ”¨ Run the development server"
    deps:
      - auth-check
      - migrate
    cmds:
      - echo "ğŸ”¨ Starting development server"
      - "{{.UV_CMD}} run uvicorn app.main:app --host 0.0.0.0 --port 8080 --reload"
    env:
      TEST_USER_EMAIL: developer@example.com
  lint:
    silent: true
    desc: ğŸ§¹ Run linters
    cmds:
      - echo "ğŸ§¹ Running linters.."
      - "{{.UV_CMD}} run ruff format ."
      - "{{.UV_CMD}} run ruff check . --fix"
      - "{{.UV_CMD}} run mypy --pretty ."
  lint-check:
    silent: true
    desc: ğŸ§¹ Check whether the codebase is linted
    cmds:
      - "{{.UV_CMD}} run ruff format --check ."
      - "{{.UV_CMD}} run ruff check ."
      - "{{.UV_CMD}} run mypy --pretty ."
  test:
    silent: true
    desc: "ğŸ§ª Run tests"
    env:
      SESSION_SECRET_KEY: test-secret-key
    cmds:
      - echo "ğŸ§ª Running tests.."
      - "{{.UV_CMD}} run pytest --disable-warnings -s --cov --cov-report=html --cov-report=term --cov-report xml:.coverage.xml"

  copyright:
    aliases:
      - license
    desc: ğŸ“œ Apply license headers
    cmds:
      - echo "ğŸ“œ Applying license headers"
      - docker run  --rm -v $PWD:/github/workspace ghcr.io/apache/skywalking-eyes/license-eye:eb0e0b091ea41213f712f622797e37526ca1e5d6
        -v info -c .licenserc.yaml header fix
  copyright-check:
    aliases:
      - license-check
    desc: ğŸ“œ Checking for license headers
    cmds:
      - echo "ğŸ“œ Checking license headers"
      - docker run  --rm -v $PWD:/github/workspace ghcr.io/apache/skywalking-eyes/license-eye:eb0e0b091ea41213f712f622797e37526ca1e5d6
        -v info -c .licenserc.yaml header check
  dev-agent:
    silent: true
    desc: ğŸ”¨ Run the development server with the local agent server
    env:
      AGENT_DEPLOYMENT_URL: http://localhost:8842
      TEST_USER_EMAIL: developer@example.com
      TEST_USER_API_KEY: '{{ .DATAROBOT_API_TOKEN }}'
    deps:
      - migrate
    cmds:
      - echo "ğŸ”¨ Starting development server"
      - "PYTHONPATH=$CALCULATED_PYTHONPATH {{.UV_CMD}} run uvicorn app.main:app --host 0.0.0.0 --port 8080 --reload"
  migrate:
    desc: ğŸ› ï¸ Migrate the database
    cmds:
      - echo "ğŸ› ï¸  Running migrations.."
      - "{{.UV_CMD}} run python alembic_migration.py"

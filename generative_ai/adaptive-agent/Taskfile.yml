---
# File generated by DataRobot CLI, regenerate using `dr task compose`
version: '3'
env:
  ENV: testing
dotenv: ['.env', '.env.{{.ENV}}']

includes:
  common:
    taskfile: ./core/task-common.yaml
    internal: true
  agent:
    taskfile: ./agent/Taskfile.yml
    dir: ./agent
  core:
    taskfile: ./core/Taskfile.yaml
    dir: ./core
  fastapi_server:
    taskfile: ./fastapi_server/Taskfile.yaml
    dir: ./fastapi_server
  frontend_web:
    taskfile: ./frontend_web/Taskfile.yaml
    dir: ./frontend_web
  infra:
    taskfile: ./infra/Taskfile.yaml
    dir: ./infra
  mcp_server:
    taskfile: ./mcp_server/Taskfile.yaml
    dir: ./mcp_server

tasks:
  default:
    desc: "â„¹ï¸ Show all available tasks (run `task --list-all` to see hidden tasks)"
    silent: true
    cmds:
      - task --list --sort none

  start:
    desc: "ğŸ’» Prepare local development environment"
    cmds:
      - dr self update
      - "echo 'âœ¨ Choose your agentic framework.'"
      - |
        PYTHONWARNINGS=ignore uvx copier recopy -a .datarobot/answers/agent-agent.yml \
        -r 11.5.5 \
        --data base_answers_file=.datarobot/answers/base.yml \
        --data agent_app_name=agent \
        --data agent_development_port=8842 \
        --data include_taskfile_infra=no \
        --data mcp_answers_file=.datarobot/answers/drmcp-mcp_server.yml \
        --data llm_answers_file=.datarobot/answers/llm-llm.yml \
        -w --quiet
      - task build-agents-md
      - dr task compose
      - dr dotenv setup --if-needed
      - dr dotenv update
      - task install
      - dr task run start
      - echo 'âœ… You are all set. Run `task dev` to start developing, or run `task deploy` to deploy to DataRobot.'
  build-agents-md:
    desc: "ğŸ“„ Build AGENTS.md file"
    cmds:
      - cmd: |
          cp AGENTS.md.template AGENTS.md
          [ -f agent/AGENTS.md ] && cat agent/AGENTS.md >> AGENTS.md
          [ -f infra/AGENTS.md ] && cat infra/AGENTS.md >> AGENTS.md
          true
        platforms: [linux, darwin]
      - cmd: |
          Copy-Item "AGENTS.md.template" "AGENTS.md"
          if (Test-Path "agent\AGENTS.md") { Get-Content "agent\AGENTS.md" | Add-Content "AGENTS.md" }
          if (Test-Path "infra\AGENTS.md") { Get-Content "infra\AGENTS.md" | Add-Content "AGENTS.md" }
        platforms: [windows]
  lint:
    desc: "ğŸ§¹ Run linters"
    cmds:
      - dr task run lint
  install:
    desc: "ğŸ› ï¸ Install all dependencies"
    cmds:
      - |
        if [ -n "$VIRTUAL_ENV" ]; then
          echo "Installing datarobot_early_access into active virtualenv: $VIRTUAL_ENV"
          uv pip install "datarobot_early_access[core]" "psutil>=7.2.1" pytz
        else
          echo "Installing datarobot_early_access as a uv tool"
          uv tool install "datarobot_early_access[core]" --with pytz,"psutil>=7.2.1"
        fi
      - dr task run install
  test:
    desc: "ğŸ§ª Run tests across all components"
    cmds:
      - dr task run test

  auth-check:
    silent: true
    desc: "ğŸ” Check authentication prerequisites"
    cmds:
      - echo "ğŸ” Checking authentication.."
      - dr auth check

  dev:
    desc: "ğŸš€ Run all services together"
    deps:
      - auth-check
    cmds:
      - drdev

  deploy:
    desc: "ğŸš€ Deploy all services"
    env:
      AGENT_DEPLOY: "1"
    cmds:
      - task: infra:deploy

  deploy-dev:
    desc: "ğŸš€ Deploy infrastructure and services to development"
    cmds:
      - task: infra:deploy-dev
